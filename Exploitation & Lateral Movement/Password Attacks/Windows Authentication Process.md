**LSA (Local Security Authority)**
- الLSA ده اهم حاجه ده عباره عن عملية او process اسمها `lsass.exe`
- **وظيفته** انه ده اللي بيتشيك علي الباسورد اللي انت دخلته وبيشوف هل هو صح ولا لأ مش بس كده ده كمss Tokenان بيديلك Acce بتتحرك بيه جوه الwindows
- الwindows بيحمي الLSA ده وبيحطه جوه protected subsystem عشان يحميه من اي فيروس
- الLSA برضو بيكون عنده security audit بيسجل فيها كل عمليات الlogin
**Kerberos**
- لو انت ف ويندوز سيرفر مثلا مش كل شوية الباسورد هيتنقل عبر الشبكه لأ ده قالك انا هديك Ticket التيكت دي متشفره وبتقول للسيرفرات الراجل ده فلان وانا اللي هو الDC انا ضامنه
- بيعتمد الkerberos علي تشفير قوي بالوقت عشان يمنع حد انه يسرق التذكره ويستخدمها بعدين وده بنسميه Replay Attack
**Security Subsystem**
- ده زي المخزن اللي عليه كل الrules علي جهازك اللي هيا الLocal Accounts وفي الشركه بتكون متخزنه علي الDomain Controller
**SIDs**
- الويندوز بتاعنا ميعرفش يعني ايه يوزر اسمه طنطاوي مثلا هو بيتعامل مع ارقام طويله ومعقده بنسيمها SID او Security Identifier
- الLSA هنا وظيفته إنه يترجم اليوزر اللي هو طنطاوي مثلا للSID بتاعه عشان علي بناءها السيستم يقدر يشوف انت ليك مثلا صلاحيه علي الaction ده ولا لأ
###### الـLogon Flow
1. انت بتكتب اليوزر والباسورد
2. الWinlogon بيبعتهم للLSA
3. الLSA بيروح يكلم الAuthentication Package سواء Kerberos او NTLM
4. لو البيانات صح الLSA هيديك Access Token ويقولك عدي
![](Pasted%20image%2020260206171110.png)**WinLogon**
- ده المسؤول عن كل حاجه ليها علاقه بالأمن وظيفته انه يقرر امتي تظهر شاشة الدخول وامتي يقفلها وامتي يطلب منك تغير الباسورد
- ليه permission انه يشوف انت بتكتب ايه علي الكيبورد keylogging
**LogonUI & Credential Providers**
- أول ما الwinlogon يقرر انك لازم تlogin بينادي علي الLogonUI
- الLogonUI دي من اسمها هيا الشاشه او الشكل اللي بيظهرلك لما تيجي تدخل الباسورد
- الCreds Providers كل طريقة تسجيل فالويندوز ليها ملف DLL خاص بيها ودي اسمها creds provider
**LSASS (Local Security Authority Subsystem Service)**
- بعد ما الWinLogon ياخد الباسورد من الcreds providers مبيعرفش يقرر هل الcreds دول صح ولا لأ ف بيروح باعتهم للLSASS وده اهم حاجه لأن ده المسؤول عن عملية الAuthentication
**Authentication Packages**
- الLSASS جوه مكتبه من ملفات الDLL وكل ملف ليه تخصص بتاعه
-Msv1_0.dll
ده بيروح يفتح ملف اسمه SAM ويقارن الهاش بتاع الباسورد اللي انت دخلته باللي متخزن عنده
-Kerberos/Netlogon
دول المحققين بيشوفو لو الجهاز تبع شركة مثلا ف بيروحو للActive Directory علاطول

---
#### LSASS
- الLSASS زي مقولنا بيتحكم في كل عمليات الauthentication
- مكانه في السيستم `%SystemRoot%\System32\Lsass.exe`
- عامل زي حارس البوابه بتاعت الويندوز

| **Authentication Packages** | **Description**                                                                                                                                                                                                                                                |
| --------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Lsasrv.dll`                | The LSA Server service both enforces security policies and acts as the security package manager for the LSA. The LSA contains the Negotiate function, which selects either the NTLM or Kerberos protocol after determining which protocol is to be successful. |
| `Msv1_0.dll`                | Authentication package for local machine logons that don't require custom authentication.                                                                                                                                                                      |
| `Samsrv.dll`                | The Security Accounts Manager (SAM) stores local security accounts, enforces locally stored policies, and supports APIs.                                                                                                                                       |
| `Kerberos.dll`              | Security package loaded by the LSA for Kerberos-based authentication on a machine.                                                                                                                                                                             |
| `Netlogon.dll`              | Network-based logon service.                                                                                                                                                                                                                                   |
| `Ntdsa.dll`                 | Directory System Agent (DSA) that manages the Active Directory database (ntds.dit), processes LDAP queries, and handles replication between domain controllers. Only loaded on Domain Controllers.                                                             |

---
#### SAM database
- الSAM او Security Account Manager دي database file في الويندوز بيتخزن فيها الuser account credentials
- بتستخدم عشان تauthenticate الLocal والremote users وبتستخدم تشفير قوي جدا عشان تمنع اي unauthorized access
- الpasswords بتتخزن علي شكل hashes في الregistry ونوع الهاش بيكون LM او NTLM
- ده مكان ملف الSAM في الويندوز  `%SystemRoot%\system32\config\SAM`
- دلوقتي ممكن assign الwindows system بتاعي لworkgroup او domain وانا بسطب الويندوز
**لو عملتله assign لworkgroup**
- الSAM هتخزن الباسوردات locally في الداتا بيز
**لو عملتله assign لdomain**
- هنا بقي تختلف هنا لازم الDomain Controller هو اللي يvalidate علي الcredentials من الActive Directory db اللي هو ntds.dit والملف ده بيتخزن في `%SystemRoot%\ntds.dit`
![](Pasted%20image%2020260206173350.png)

- الCred Manager ده عامل زي الخزنة الشخصيه شوفت الpassword manager اللي بيكون في المتصفحات ده زيو بالظبط بس فالويندوز
- ولنفترض إنك مش عايز كل ماتيجي تفتح فولدر مشترك علي الشبكه او تفتح سيرفر RDP او حتي تدخل علي موقع او تطبيق إنك كل شوية تكتب باسورد
- **وظيفة** الcred manager هنا بقي انه بيعرض عليك تحفظ البيانات دي وبيركنها عنده ف مكان اسمه Credential Locker
الخزنة دي متقسمة لجزئين أساسيين:

- ال**Web Credentials:** دي الباسوردات اللي بتتحفظ من متصفح Internet Explorer أو Microsoft Edge
    
- ال**Windows Credentials:** ودي الأهم، ودي اللي فيها باسوردارت الـ **Shared Folders**، وسيرفرات الـ **RDP**، وبرامج زي الـ **Outlook** أو الـ **Teams**
```powershell-session
PS C:\Users\[Username]\AppData\Local\Microsoft\[Vault/Credentials]\
```
وده مكانها

---
#### NTDS
- دايما هتقابلك الحاجه دي فالnetwork env لما جهاز ويندوز يبقي دومين من ضمن الدومينات الموجوده فالشركه
- زي مقولنا فوق ده بقي الملف اللي بيكون الباسورد اللي DC بيvalidate علي الباسورد بتاعك من عليه
`NTDS.dit` is a database file that stores Active Directory data, including but not limited to:

- User accounts (username & password hash)
- Group accounts
- Computer accounts
- Group policy objects
---
