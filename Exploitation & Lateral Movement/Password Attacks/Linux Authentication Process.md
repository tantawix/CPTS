- الlinux-based distributions بتsupport auth mechanisms كتير
- واحده من اشهر الmechanisms هيا الPAM الPAM بيستخدم مودويلات زي `pam_unix.so` الموديول ده هو اللي بيفحص الباسورد صح ولا لأ ومسؤول انه يحط الباسورد في ملف الshadow لو بتغير الباسورد ولا حاجه
- الموديول ده بيكون موجود في `/usr/lib/x86_64-linux-gnu/security/` في الDebian كل الموديولات هنا مسؤوله عن الuser info والauth والsessions والpassword changes
- يعني مثلا انت لو بتغير الباسورد بتاع نظامك بتكتب امر `passwd` عشان تغيره النظام ده مش بيعمل ده من نفسه لأ هو بيروح ينادي علي الPAM فالPAM بتشغل مودويلات زي `pam_unix.so` الموديول ده بقي بيفحص هل الباسورد القديم صح ولا لأ طب الجديد قوي ولا لأ وهو الل بيرح يحدث الباسورد في ملف الshadow
- ال`pam_unix.so` بيستخدم standardized API calls من الsystem libraries عشان يحدث الaccount info
- الملفات الرئيسيه اللي بيقرأ ويكتب فيها هيا `/etc/passwd` و `/etc/shadow`
----
## Passwd file
- ملف ال`etc/passwd/` بيحتوي علي معلومات عن كل يوزر فالسيستم والبيانات دي readable لكل الناس مش متشفره يعني
- كل entry فالفايل ده او كل سطر يعني بيعبر ليوزر واحد والentry او السطر الواحد بيتكون من 7 fieldsكل field مفصول عن التاني بcolon اللي هيا دي :
```shell-session
htb-student:x:1000:1000:,,,:/home/htb-student:/bin/bash
```

|Field|Value|
|---|---|
|Username|`htb-student`|
|Password|`x`|
|User ID|`1000`|
|Group ID|`1000`|
|[GECOS](https://en.wikipedia.org/wiki/Gecos_field)|`,,,`|
|Home directory|`/home/htb-student`|
|Default shell|`/bin/bash`|
- سيبك من ده كله احنا اهم field ف دول هو الPassword field في حالات نادره كده ممكن تلاقي الpassword hash إنما في الانظمه الجديده شويه هتلاقي الباسورد في ملف `etc/shadow/` إنما من المعتاد انك تلاقي field الباسورد فيه x كده وده معناه انه مش مكتوب وانه متخزن في ال`etc/shadow/`
- ملف الpasswd ممكن اي حد يقرأه بس محدش يعدل فيه غير الroot ولو الadmin سايبه writeable لأي حد ف دي مصيبه لأنك هتقدر تعدل فيه وتقدر كمان تمسح باسورد الroot ويبقي من غير باسورد

```shell-session
0xTroj6n@htb[/htb]$ head -n 1 /etc/passwd

root::0:0:root:/root:/bin/bash
```

This results in no password prompt being displayed when attempting to log in as `root`.

```shell-session
0xTroj6n@htb[/htb]$ su

root@htb[/htb]#
```
---
## Shadow file
- ملف الshadow بقي مسؤول عن الpassword storage and management وبيكون فيه كل الpassword information لكل يوزر في السيستم
- ملف الshadow كل entry فيه بيتكون من 9 fields
- 
```shell-session
htb-student:$y$j9T$3QSBB6CbHEu...SNIP...f8Ms:18955:0:99999:7:::
```

|Field|Value|
|---|---|
|Username|`htb-student`|
|Password|`$y$j9T$3QSBB6CbHEu...SNIP...f8Ms`|
|Last change|`18955`|
|Min age|`0`|
|Max age|`99999`|
|Warning period|`7`|
|Inactivity period|`-`|
|Expiration date|`-`|
|Reserved field|`-`|
- لو الpassword field فيه حروف زي `!` او `*` يبقي الحساب ده مقفول وممنوع يدخل باستخدام باسورد عادي
- ولو الfield فاضي ف كده مفيش باسورد ومسموح ليه يدخل
- ولو لقيت الfield فيه `!!` يعني حساب لسه ملوش باسورد ومش هتعرف تدخل الا بباسورد
- فورمات الhash بتاع الباسورد بيكون كده
`$<id>$<salt>$<hashed>`
بص الهاش بيتقسم لتلت اجزاء الID value بيعبر عن نوع الهاش

|ID|Cryptographic Hash Algorithm|
|---|---|
|`1`|[MD5](https://en.wikipedia.org/wiki/MD5)|
|`2a`|[Blowfish](https://en.wikipedia.org/wiki/Blowfish_\(cipher\))|
|`5`|[SHA-256](https://en.wikipedia.org/wiki/SHA-2)|
|`6`|[SHA-512](https://en.wikipedia.org/wiki/SHA-2)|
|`sha1`|[SHA1crypt](https://en.wikipedia.org/wiki/SHA-1)|
|`y`|[Yescrypt](https://github.com/openwall/yescrypt)|
|`gy`|[Gost-yescrypt](https://www.openwall.com/lists/yescrypt/2019/06/30/1)|
|`7`|[Scrypt](https://en.wikipedia.org/wiki/Scrypt)|
معظم الlinux dist بيستخدمو ال`yescrypt` كا default hashing alogrithm إنما في الانظمه القديمه هتلاقي انواع مختلفه كتير

---
## Opasswd
- الPAM library ممكن تمنع الusers من اعادة استخدام باسوردات قديمه كانو عاملينها قبل كده
- الباسوردات القديمه دي بتكون متخزنه في `etc/security/opasswd/` والملف ده بيحتاج admin privileges عشان تقرأ الملف

```shell-session
0xTroj6n@htb[/htb]$ sudo cat /etc/security/opasswd

cry0l1t3:1000:2:$1$HjFAfYTG$qNDkF0zJ3v8ylCOrKB0kt0,$1$kcUjWZJX$E9uMSmiQeRh4pAAgzuvkq1
```
User : cry0l13
ID : $1$ MD5 easier to crack than SHA-512

---
## Cracking Linux Credentials
- بمجرد مايكون معانا root access علي الماشين ممكن نجمع الuser hashes ونحاول نكراكهم
- في tool اسمها unshadow دي بتشتغل مع الJohn the Ripper ودي بتجمع بين ملف الshadow وال passwd

```shell-session
0xTroj6n@htb[/htb]$ sudo cp /etc/passwd /tmp/passwd.bak 
0xTroj6n@htb[/htb]$ sudo cp /etc/shadow /tmp/shadow.bak 
```

```shell-session
0xTroj6n@htb[/htb]$ unshadow /tmp/passwd.bak /tmp/shadow.bak > /tmp/unshadowed.hashes
```

This "unshadowed" file can now be attacked with either JtR or hashcat.

```shell-session
0xTroj6n@htb[/htb]$ hashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked
```
---
